{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Sidebar - Settings -->
    <div class="col-lg-4">
        <!-- Cookies Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cookie-bite"></i> Upload Cookies</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('upload_cookies') }}" method="post" enctype="multipart/form-data">
                    <div class="upload-area" onclick="document.getElementById('cookiesFile').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h6>Kéo thả file cookies hoặc nhấn để chọn</h6>
                        <p class="text-muted">Hỗ trợ .txt và .json</p>
                        <input type="file" id="cookiesFile" name="cookies_file" accept=".txt,.json" style="display: none;" onchange="updateFileName(this, 'cookiesFileName')">
                    </div>
                    <div id="cookiesFileName" class="mt-2 text-muted"></div>
                    <button type="submit" class="btn btn-primary w-100 mt-3">
                        <i class="fas fa-upload"></i> Upload Cookies
                    </button>
                </form>
                
                <!-- Cookies Status -->
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>Trạng thái Cookies:</h6>
                    {% if app_state.cookies_loaded %}
                        <span class="text-success">
                            <i class="fas fa-check-circle"></i> 
                            Đã kết nối ({{ app_state.cookies_file }})
                        </span>
                    {% else %}
                        <span class="text-danger">
                            <i class="fas fa-times-circle"></i> 
                            Chưa kết nối
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Video Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Cài đặt Video</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Kích thước Video</label>
                    <select class="form-select" id="aspectRatio">
                        <option value="16:9">16:9 (Landscape)</option>
                        <option value="9:16">9:16 (Portrait)</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Độ dài Video (giây)</label>
                    <select class="form-select" id="duration">
                        <option value="5">5 giây</option>
                        <option value="6">6 giây</option>
                        <option value="7">7 giây</option>
                        <option value="8">8 giây</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Độ phân giải</label>
                    <select class="form-select" id="resolution">
                        <option value="720p">720p (HD)</option>
                        <option value="1080p" selected>1080p (Full HD)</option>
                        <option value="1440p">1440p (2K)</option>
                        <option value="2160p">2160p (4K)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Prompt Generator -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-magic"></i> Tạo Prompt Tự Động</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Mô tả video bạn muốn tạo:</label>
                    <textarea class="form-control" id="userDescription" rows="3" 
                              placeholder="VD: Một người đàn ông đi bộ trên bãi biển lúc hoàng hôn"></textarea>
                </div>
                <button type="button" class="btn btn-success w-100" onclick="generatePrompt()">
                    <i class="fas fa-wand-magic-sparkles"></i> Tạo Prompt VEO3
                </button>
                
                <div id="generatedPrompt" class="mt-3" style="display: none;">
                    <label class="form-label">Prompt đã tối ưu:</label>
                    <textarea class="form-control" id="optimizedPrompt" rows="4" readonly></textarea>
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="copyPrompt()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Prompts Upload -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-text"></i> Upload File Prompts</h5>
            </div>
            <div class="card-body">
                <div class="upload-area" onclick="document.getElementById('promptsFile').click()">
                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                    <h6>Kéo thả file prompts hoặc nhấn để chọn</h6>
                    <p class="text-muted">File .txt với mỗi dòng là một prompt</p>
                    <input type="file" id="promptsFile" accept=".txt" style="display: none;" onchange="uploadPrompts(this)">
                </div>
                <div id="promptsFileName" class="mt-2 text-muted"></div>
                
                <!-- Prompts Preview -->
                <div id="promptsPreview" class="mt-3" style="display: none;">
                    <h6>Preview Prompts:</h6>
                    <div id="promptsList" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"></div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-lg" onclick="startGeneration()" 
                                {% if not app_state.cookies_loaded %}disabled{% endif %}>
                            <i class="fas fa-play"></i> Bắt đầu tạo Video
                        </button>
                        {% if not app_state.cookies_loaded %}
                            <div class="text-muted mt-2">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Vui lòng upload cookies trước
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Generation Progress -->
        <div class="card mb-4 progress-container" id="progressContainer">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> Tiến trình tạo Video</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressStatus">Đang chuẩn bị...</div>
                <div id="currentPrompt" class="text-muted mt-2"></div>
            </div>
        </div>

        <!-- Generated Videos -->
        <div class="card" id="videosContainer" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-video"></i> Videos đã tạo</h5>
            </div>
            <div class="card-body">
                <div id="videosList"></div>
                <button type="button" class="btn btn-success" onclick="downloadAllVideos()">
                    <i class="fas fa-download"></i> Tải tất cả Videos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingMessage">Đang xử lý...</h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentPrompts = [];
let generationInProgress = false;

// Update file name when selected
function updateFileName(input, displayId) {
    const display = document.getElementById(displayId);
    if (input.files && input.files[0]) {
        display.innerHTML = `<i class="fas fa-file"></i> ${input.files[0].name}`;
    } else {
        display.innerHTML = '';
    }
}

// Upload prompts file
async function uploadPrompts(input) {
    if (!input.files || !input.files[0]) return;
    
    updateFileName(input, 'promptsFileName');
    
    const formData = new FormData();
    formData.append('prompts_file', input.files[0]);
    
    showLoading('Đang tải file prompts...');
    
    try {
        const response = await fetch('/upload_prompts', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.status === 'success') {
            currentPrompts = result.prompts || [];
            displayPromptsPreview(result.prompts_count, result.prompts);
            showAlert('success', result.message);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        hideLoading();
        showAlert('danger', 'Lỗi khi tải file: ' + error.message);
    }
}

// Display prompts preview
function displayPromptsPreview(count, prompts) {
    const preview = document.getElementById('promptsPreview');
    const list = document.getElementById('promptsList');
    
    list.innerHTML = '';
    prompts.forEach((prompt, index) => {
        list.innerHTML += `<div class="mb-2"><strong>${index + 1}:</strong> ${prompt}</div>`;
    });
    
    if (count > 5) {
        list.innerHTML += `<div class="text-muted">... và ${count - 5} prompts khác</div>`;
    }
    
    preview.style.display = 'block';
}

// Generate optimized prompt
async function generatePrompt() {
    const description = document.getElementById('userDescription').value.trim();
    if (!description) {
        showAlert('warning', 'Vui lòng nhập mô tả video!');
        return;
    }
    
    showLoading('Đang tạo prompt tối ưu...');
    
    try {
        const response = await fetch('/generate_prompt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ description: description })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.status === 'success') {
            document.getElementById('optimizedPrompt').value = result.optimized_prompt;
            document.getElementById('generatedPrompt').style.display = 'block';
            showAlert('success', 'Prompt đã được tạo thành công!');
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        hideLoading();
        showAlert('danger', 'Lỗi khi tạo prompt: ' + error.message);
    }
}

// Copy prompt to clipboard
function copyPrompt() {
    const prompt = document.getElementById('optimizedPrompt');
    prompt.select();
    document.execCommand('copy');
    showAlert('info', 'Prompt đã được copy!');
}

// Start video generation
async function startGeneration() {
    if (generationInProgress) return;
    if (currentPrompts.length === 0) {
        showAlert('warning', 'Vui lòng upload file prompts trước!');
        return;
    }
    
    const settings = {
        aspect_ratio: document.getElementById('aspectRatio').value,
        duration: document.getElementById('duration').value,
        resolution: document.getElementById('resolution').value
    };
    
    generationInProgress = true;
    document.getElementById('progressContainer').style.display = 'block';
    
    try {
        const response = await fetch('/start_generation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('success', result.message);
            startProgressMonitoring();
        } else {
            showAlert('danger', result.message);
            generationInProgress = false;
        }
    } catch (error) {
        showAlert('danger', 'Lỗi khi bắt đầu tạo video: ' + error.message);
        generationInProgress = false;
    }
}

// Monitor generation progress
async function startProgressMonitoring() {
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    const currentPromptDiv = document.getElementById('currentPrompt');
    
    const checkStatus = async () => {
        try {
            const response = await fetch('/generation_status');
            const status = await response.json();
            
            const progress = Math.round((status.completed_videos / status.total_prompts) * 100);
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            
            progressStatus.textContent = `Hoàn thành: ${status.completed_videos}/${status.total_prompts} videos`;
            
            if (status.videos && status.videos.length > 0) {
                const lastVideo = status.videos[status.videos.length - 1];
                currentPromptDiv.textContent = `Đang xử lý: ${lastVideo.prompt.substring(0, 50)}...`;
            }
            
            if (status.status === 'completed') {
                progressStatus.textContent = 'Hoàn thành tất cả videos!';
                progressBar.className = 'progress-bar bg-success';
                generationInProgress = false;
                displayGeneratedVideos(status.videos);
                showAlert('success', `Đã tạo thành công ${status.completed_videos} videos!`);
                return;
            } else if (status.status === 'error') {
                progressStatus.textContent = 'Có lỗi xảy ra trong quá trình tạo video!';
                progressBar.className = 'progress-bar bg-danger';
                generationInProgress = false;
                showAlert('danger', 'Quá trình tạo video gặp lỗi!');
                return;
            }
            
            // Continue monitoring
            setTimeout(checkStatus, 2000);
            
        } catch (error) {
            console.error('Error checking status:', error);
            setTimeout(checkStatus, 5000); // Retry after longer delay
        }
    };
    
    checkStatus();
}

// Display generated videos
function displayGeneratedVideos(videos) {
    const container = document.getElementById('videosContainer');
    const list = document.getElementById('videosList');
    
    list.innerHTML = '';
    videos.forEach((video, index) => {
        list.innerHTML += `
            <div class="video-item">
                <h6><i class="fas fa-video"></i> Video ${index + 1}</h6>
                <p class="text-muted">${video.prompt}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-success">Completed</span>
                    <a href="/download/${video.filename}" class="btn btn-primary btn-sm">
                        <i class="fas fa-download"></i> Tải về
                    </a>
                </div>
            </div>
        `;
    });
    
    container.style.display = 'block';
}

// Download all videos
function downloadAllVideos() {
    // Implementation for bulk download
    showAlert('info', 'Tính năng tải tất cả đang được phát triển...');
}

// Utility functions
function showLoading(message) {
    document.getElementById('loadingMessage').textContent = message;
    new bootstrap.Modal(document.getElementById('loadingModal')).show();
}

function hideLoading() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) modal.hide();
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Gemini VEO3 Generator initialized');
    
    // Check if generation is in progress on page load
    fetch('/generation_status')
        .then(response => response.json())
        .then(status => {
            if (status.status === 'processing') {
                generationInProgress = true;
                document.getElementById('progressContainer').style.display = 'block';
                startProgressMonitoring();
            } else if (status.videos && status.videos.length > 0) {
                displayGeneratedVideos(status.videos);
            }
        })
        .catch(error => console.error('Error checking initial status:', error));
});
</script>
{% endblock %}